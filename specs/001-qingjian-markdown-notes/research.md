# Research: 青简（qingjian）Markdown 笔记应用（macOS/iOS）

**Branch**: `001-qingjian-markdown-notes`  
**Date**: 2025-12-25  
**Spec**: [spec.md](./spec.md)  
**Plan**: [plan.md](./plan.md)

本文件用于在实现前收敛关键技术决策与风险，确保：跨端一致性、性能预算、离线与可移植、冲突可恢复（符合 Constitution）。

---

## 1) Decision: 共享核心 + 平台薄 UI 的分层边界

**Decision**: 建立 `QingJianCore` 作为共享核心，包含 domain 模型、文件存储、Repo 元数据、索引/搜索、同步语义与冲突处理；macOS/iOS 仅实现 UI 与平台能力接入。

**Rationale**:
- 满足宪法“结果一致/语义一致”，避免两端重复实现导致行为分叉
- 性能优化更集中（缓存、异步 I/O、增量索引）

**Alternatives considered**:
- 双端各自实现核心逻辑：一致性与维护成本不可控

---

## 2) Decision: Repo 数据组织（Markdown + 资产 + 元数据）

**Decision**: Repo 物理上是一个用户可见文件夹；笔记为 `.md` 文本；图片资产保存在 Repo 内固定目录（例如 `assets/`）；自定义排序/状态等存入 Repo 内的“元数据文件”（例如 `.qingjian/metadata.json` 或等价结构）。

**Rationale**:
- 用户可直接用 git/云盘同步，符合“文件即真相”
- 资产随 Repo 迁移/导出简单
- 自定义排序不依赖文件系统默认排序，满足 FR-015

**Alternatives considered**:
- 依赖文件系统排序：无法满足拖拽排序与稳定展示
- 将元数据存到系统私有数据库：破坏可移植与透明性

**Open issues resolved**:
- 文件系统新增/删除/重命名：以“路径”为主键不稳定 → 元数据需支持“可重新关联”的策略（见第 4 节）

---

## 3) Decision: Markdown 渲染与预览更新策略（性能与体验）

**Decision**:
- View/预览渲染采用“增量与缓存优先”的策略：对同一笔记缓存解析/渲染结果；编辑时采用节流（debounce）更新预览；大文件降级（例如分段渲染或延迟语法高亮）。
- 暗色模式/字体缩放等作为渲染主题输入，主题变化触发必要的重渲染与缓存失效。

**Rationale**:
- 满足 SC-003/SC-004 的响应目标
- 大文件必须可降级，否则会破坏编辑/滚动体验

**Alternatives considered**:
- 逐字即时渲染：成本高且不必要，易引入卡顿

**Notes**:
- 具体 Markdown 引擎选择在实现阶段确定，但必须满足：常见语法覆盖、图片/链接处理、暗色主题、性能可控与可测

---

## 4) Decision: 自定义排序元数据与文件系统变更一致性

**Decision**:
- Repo 元数据维护“目录节点的有序子列表”，按路径记录；当检测到文件系统变化时：
  - 新增项：插入到列表末尾（或用户上次排序策略），并标记为“未排序新项”
  - 删除项：从列表移除
  - 重命名/移动：尽可能通过变更事件匹配（同一文件的 rename 事件）更新路径；无法判断时作为“删除+新增”处理，并提示用户（可选）

**Rationale**:
- 保持用户拖拽排序的稳定性
- 允许外部工具改动文件结构，同时保证 UI 行为可预测

**Alternatives considered**:
- 为每个文件写入内部 ID 到文件内容：污染用户 Markdown
- 完全忽略外部变更：会导致“看不到新文件/排序错乱”

---

## 5) Decision: 文件变更监听（外部编辑器/git/云盘）

**Decision**:
- 监听 Repo 根目录的文件系统变化事件，采用去抖与批处理更新：
  - 目录树：批量重扫受影响目录
  - 索引：增量更新变更的文件集合
  - 当前打开笔记：若外部变更导致内容变化，提示“文件已在外部修改，是否重新加载/对比”（避免静默覆盖）

**Rationale**:
- “文件即真相”下，外部变更必须被应用感知
- 批处理是性能关键，避免频繁刷新导致卡顿

**Alternatives considered**:
- 定时全量扫描：在大 Repo 下成本过高，且体验不及时

---

## 6) Decision: iCloud 同步语义与冲突处理（Q2=B）

**Decision**:
- iCloud 同步只同步“Repo 文件夹内容”（Markdown/资产/元数据），不引入额外封装。
- 冲突策略：出现冲突时**提示用户处理**，并支持“选择保留版本”或“合并后保存”。默认不做静默覆盖。

**Rationale**:
- 满足宪法“冲突可解释可恢复”，避免丢内容
- 符合你选择的 Q2=B

**Alternatives considered**:
- 自动保留两份：更安全但会制造重复；可作为兜底策略
- 最后写入覆盖：易丢数据，不符合定位

**Operational notes**:
- 冲突 UI 要在 macOS/iOS 语义一致（即使 iOS 只读，也要能看到冲突并执行“保留/合并”的决策入口；合并可在 macOS 完成）

---

## 7) Decision: iOS 端只读 + 快捷操作（Q1=C）

**Decision**: iOS 仅提供 View 模式与快捷操作：复制、分享、导出/系统共享；不提供编辑器与 Vim 模式。

**Rationale**:
- 降低实现复杂度，减少跨端编辑一致性与冲突风险
- 更贴合移动端“随手阅读/分享”的使用场景

**Alternatives considered**:
- iOS 基础编辑：需要更完整的冲突处理与编辑体验投入

---

## 8) Decision: 试用到期策略（Q3=B）

**Decision**: 7 天试用到期未购买 → 应用进入锁定状态并引导购买，但必须保留“导出/迁移 Repo”的路径。

**Rationale**:
- 商业策略清晰，同时保障用户数据可达性与可迁移性

**Alternatives considered**:
- 只读继续查看：更温和，但削弱付费转化
- 限制高级功能：边界复杂，容易引发困惑

---

## 9) Performance Gates: 指标与测量方式（门禁化）

**Decision**: 将以下指标作为实现阶段的性能门禁（以 Debug/本地测量为主，阈值来自 spec/plan）：

- 冷启动到可交互：≤ 2s
- 打开含 1,000 笔记 Repo 到可浏览：≤ 2s
- 切换笔记进入 View：p95 ≤ 300ms
- 预览更新可见：p95 ≤ 200ms（允许节流）

**Measurement approach**:
- 关键路径埋点（启动、Repo 扫描完成、索引完成、渲染开始/结束）
- 性能测试用固定样例 Repo（规模可重复）

**Alternatives considered**:
- 仅凭主观体感：不可回归、无法满足宪法“零回归”


