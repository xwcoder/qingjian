# Feature Specification: 仓库内目录与笔记管理

**Feature Branch**: `[003-repo-folder-notes]`  
**Created**: 2025-12-25  
**Status**: Draft  
**Input**: User description: "实现在选中仓库下的目录管理和笔记管理功能"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 在选中仓库中创建与使用笔记（Priority: P1）

用户在应用中选中一个仓库后，可以在该仓库范围内浏览目录/笔记列表，并在指定目录（或根目录）创建新笔记、打开笔记进行查看/继续编辑，从而完成“开始记笔记”的主任务。

**Why this priority**: 这是用户最核心、最频繁的价值路径；没有“在仓库里创建并打开笔记”，目录管理本身无法独立体现收益。

**Independent Test**: 仅实现本故事即可完成最小可用闭环：选中仓库 → 进入内容列表 → 新建笔记 → 打开笔记 → 确认在列表中可再次找到并打开。

**Acceptance Scenarios**:

1. **Given** 用户已选中一个可用仓库且位于该仓库内容视图，**When** 用户在根目录新建笔记并输入标题，**Then** 新笔记出现在列表中且可被打开。
2. **Given** 用户已在某个目录内浏览，**When** 用户在该目录中新建笔记，**Then** 新笔记归属于该目录，返回上级后仍可通过目录导航再次定位并打开。
3. **Given** 用户正在编辑笔记且存在未保存更改，**When** 用户尝试切换到另一条笔记，**Then** 系统提示如何处理未保存更改（保留/放弃/取消操作），用户选择后行为符合提示。

---

### User Story 2 - 管理仓库内目录结构（Priority: P2）

用户可以在选中仓库下创建目录、重命名目录、移动目录（改变层级/顺序）、删除目录，从而把笔记按主题整理成结构化内容，提升检索与维护效率。

**Why this priority**: 目录结构是仓库规模变大后的关键能力，直接影响日常整理成本与可发现性。

**Independent Test**: 仅实现目录的增/改名/移动/删除，也能独立验证“目录树可维护”，并为后续笔记管理提供组织载体。

**Acceptance Scenarios**:

1. **Given** 用户位于仓库内容视图，**When** 用户创建一个新目录并命名，**Then** 目录立即可见且可进入浏览。
2. **Given** 目录 A 已存在，**When** 用户将目录 A 重命名为目录 B，**Then** 列表/导航中显示新名称，且目录内的笔记仍保持归属不变。
3. **Given** 目录 A 与目录 C 已存在，**When** 用户将目录 A 移动到目录 C 之下，**Then** 导航层级更新，且用户可从目录 C 下找到目录 A 及其内容。
4. **Given** 目录 A 非空（包含子目录或笔记），**When** 用户删除目录 A，**Then** 系统要求明确确认删除范围（包含其全部子内容），确认后目录 A 与其子内容不再出现在仓库内。

---

### User Story 3 - 整理与维护笔记（重命名/移动/删除）（Priority: P3）

用户可以对仓库内已有笔记进行重命名、移动到其他目录、删除，从而在内容持续增长时仍能保持结构与命名的可维护性。

**Why this priority**: 这是高频整理动作，解决“笔记越写越乱”的痛点；但相较 P1，属于在已有内容基础上的增强。

**Independent Test**: 仅实现笔记的重命名/移动/删除，可独立验证内容维护能力，不依赖目录的复杂能力（可在根目录下完成测试）。

**Acceptance Scenarios**:

1. **Given** 仓库内存在笔记 N，**When** 用户重命名笔记 N，**Then** 列表、打开页及任何引用该笔记的入口都展示新名称。
2. **Given** 笔记 N 位于目录 A 且目录 B 存在，**When** 用户将笔记 N 从目录 A 移动到目录 B，**Then** 目录 A 中不再显示该笔记，目录 B 中显示该笔记且可打开。
3. **Given** 用户选择删除笔记 N，**When** 用户确认删除，**Then** 笔记 N 不再出现在仓库内，且不会因缓存/刷新重新出现。

---

### Edge Cases

- 同一目录下创建/重命名目录或笔记时发生重名：系统应阻止并给出可理解的提示，或提供自动更名选项（例如追加序号），且结果可预测、可复现。
- 目录移动到其自身或其子目录下：系统应阻止该操作并提示原因。
- 删除非空目录：系统必须明确提示会连带删除的范围，并要求二次确认。
- 仓库在操作过程中变为不可用（例如被移除、被锁定、权限变化）：系统应停止当前操作并给出恢复指引（返回仓库选择、重新授权或重试）。
- 用户在编辑未保存更改的笔记时执行移动/删除：系统应先处理未保存更改（保留/放弃/取消），避免无提示丢失内容。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 允许用户在已选中的仓库范围内浏览目录层级与笔记列表，并清晰区分“目录”和“笔记”条目。
- **FR-002**: 系统 MUST 允许用户在仓库根目录创建目录，并支持创建多级目录（目录可包含子目录）。
- **FR-003**: 系统 MUST 允许用户重命名目录；若新名称与同级已有目录或笔记冲突，系统 MUST 阻止并提供冲突提示或可选的自动更名策略。
- **FR-004**: 系统 MUST 允许用户移动目录到另一个目录之下；系统 MUST 阻止将目录移动到其自身或其子目录中。
- **FR-005**: 系统 MUST 允许用户删除目录；当目录非空时，系统 MUST 明确提示删除范围并要求确认后才执行。
- **FR-006**: 系统 MUST 允许用户在仓库根目录或任意目录下创建新笔记，并在创建后立即可被打开。
- **FR-007**: 系统 MUST 允许用户打开任意笔记进行查看/继续编辑，并在返回列表后仍能定位到该笔记。
- **FR-008**: 系统 MUST 允许用户重命名笔记；若与同级已有目录或笔记冲突，系统 MUST 阻止并提供冲突提示或可选的自动更名策略。
- **FR-009**: 系统 MUST 允许用户在目录之间移动笔记，移动后笔记内容不变且可在目标目录中打开。
- **FR-010**: 系统 MUST 允许用户删除笔记；删除前 MUST 提供确认以避免误操作。
- **FR-011**: 当用户对笔记存在未保存更改时，系统 MUST 在切换/移动/删除等可能导致内容丢失的操作前提示用户选择处理方式（保留/放弃/取消）。
- **FR-012**: 系统 MUST 将所有目录与笔记管理操作严格限定在“当前选中仓库”范围内，避免对其他仓库产生影响。

### Key Entities *(include if feature involves data)*

- **Repository（仓库）**: 用户当前选中的内容集合范围；包含目录树与笔记集合；具备可用性状态（可用/不可用/需要重新授权等）。
- **Folder（目录）**: 仓库内用于组织内容的层级节点；关键属性包括名称、父目录关系、同级排序信息、唯一标识。
- **Note（笔记）**: 仓库内的内容条目；关键属性包括名称、所属目录、内容、最近修改时间、唯一标识。
- **Selection State（选择状态）**: 当前选中仓库、当前所在目录、当前打开笔记等，用于保证用户操作作用域清晰且可回溯。

### Assumptions & Scope Boundaries

- **依赖前置能力**：用户已经可以“选择/切换仓库”，且系统能识别仓库是否可用（不可用时给出恢复路径）。
- **默认支持多级目录**：目录可嵌套，且可在层级间移动（受 FR-004 约束）。
- **删除为显式确认后的永久移除**：删除操作不会“静默保留”；系统通过确认流程降低误删风险。
- **不包含的范围**：不要求实现跨仓库移动目录/笔记，不要求实现全文搜索/标签/共享协作等扩展能力（后续可另立功能）。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 90% 的新用户在首次使用时可在 60 秒内完成“选中仓库 → 创建笔记 → 打开笔记”的主流程（可通过可用性测试验证）。
- **SC-002**: 用户在仓库内完成一次“创建目录并进入浏览”的操作平均用时不超过 30 秒（可通过可用性测试验证）。
- **SC-003**: 对于包含 1,000 条笔记的仓库，用户执行“移动一条笔记到其他目录”后，列表更新与可再次打开该笔记的等待时间在 2 秒内（可通过性能测试验证）。
- **SC-004**: 目录/笔记的重命名、移动、删除操作在常见场景下成功率达到 99%（失败必须有明确可理解的错误提示与可恢复路径，例如重试或取消）。
