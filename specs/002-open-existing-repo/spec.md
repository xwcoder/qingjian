# Feature Specification: 打开已有仓库（添加已有仓库）

**Feature Branch**: `002-open-existing-repo`  
**Created**: 2025-12-25  
**Status**: Draft  
**Input**: 用户描述：「现有的添加仓库功能本质上是新建仓库功能；在新建仓库之外另实现添加已有仓库功能：本地已有某个仓库（文件夹中含有仓库的 meta 信息），提供将其添加（打开）到 App 仓库列表的功能。仓库列表上方的 + 按钮添加下拉两个 menu：新建仓库、打开仓库。」

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 从本地“打开仓库”并加入仓库列表 (Priority: P1)

用户在仓库列表页点击顶部“+”，选择“打开仓库”，从本地选择一个已存在的仓库文件夹；系统校验该文件夹包含有效的仓库元信息后，将该仓库加入 App 的仓库列表，并可立即打开/进入该仓库。

**Why this priority**: 这是“添加已有仓库”功能的核心价值：把用户已经存在于本地的仓库快速纳入 App 管理，而不是重新创建。

**Independent Test**: 准备一个包含有效仓库元信息的本地仓库文件夹；在 App 中执行“+ → 打开仓库 → 选择该文件夹”，即可验证仓库被加入列表并可进入。

**Acceptance Scenarios**:

1. **Given** 仓库列表中尚未包含目标仓库，且本地存在一个包含有效仓库元信息的仓库文件夹，**When** 用户选择“+ → 打开仓库”并选中该文件夹，**Then** 系统将该仓库添加到仓库列表，并在列表中可见且可被打开。
2. **Given** 用户位于仓库列表页，**When** 用户点击“+”，**Then** 用户可以看到两个可选入口：“新建仓库”和“打开仓库”，且二者文案清晰可区分。
3. **Given** 目标仓库已存在于仓库列表（相同路径或相同仓库标识），**When** 用户再次通过“打开仓库”选择该仓库文件夹，**Then** 系统不新增重复条目，并将用户引导到已存在的仓库条目以便直接打开。

---

### User Story 2 - 对无效/不可用仓库给出可理解的反馈 (Priority: P2)

当用户选择的文件夹不是仓库、仓库元信息损坏/缺失、或目录不可访问时，系统不应把它加入仓库列表；应给出明确、可操作的错误提示，并允许用户重新选择。

**Why this priority**: 打开本地文件夹存在大量错误输入与权限/路径问题；良好反馈能避免“列表里出现打不开的仓库”并降低用户困惑。

**Independent Test**: 分别用“普通文件夹”“缺失元信息的仓库目录”“不可访问目录”进行“打开仓库”，验证不会被添加且提示信息明确。

**Acceptance Scenarios**:

1. **Given** 用户选择的文件夹不包含可识别的仓库元信息，**When** 用户尝试“打开仓库”，**Then** 系统提示“所选文件夹不是可打开的仓库”（或同等清晰语义），且仓库列表不新增条目。
2. **Given** 用户选择的文件夹包含仓库元信息但已损坏或不完整，**When** 用户尝试“打开仓库”，**Then** 系统提示“仓库信息损坏/不完整，无法打开”（或同等清晰语义），且仓库列表不新增条目。
3. **Given** 用户选择的文件夹不可访问（例如权限不足、路径不存在、被占用等），**When** 用户尝试“打开仓库”，**Then** 系统提示“无法访问所选位置”（或同等清晰语义），且仓库列表不新增条目。
4. **Given** 某仓库已在仓库列表中但其位置已不可用（例如被移动或删除），**When** 用户尝试从仓库列表打开该仓库，**Then** 系统提示“仓库位置不可用”（或同等清晰语义），并提供至少一种恢复路径（例如移除条目或重新选择位置）。

### Edge Cases

- 用户选择的仓库已存在于仓库列表（相同路径或相同仓库标识）时：不应重复添加；应引导用户定位到已存在条目并直接打开。
- 用户选择的仓库在添加成功后被移动/删除：在后续打开时应提示“仓库位置不可用”，并提供从列表移除或重新定位的选项。
- 用户在选择过程中取消：不应产生任何新增条目或副作用。
- 同一仓库被多窗口/多实例重复打开（如果产品允许多窗口）：应避免产生重复列表项或状态紊乱。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 在仓库列表页的“+”入口同时提供两个操作：“新建仓库”和“打开仓库”。
- **FR-001a**: 系统 MUST 保留并继续支持原有“新建仓库”能力；本功能新增的“打开仓库”不得替换、隐藏或移除“新建仓库”入口，且不应引入对“新建仓库”流程的回归。
- **FR-002**: 系统 MUST 允许用户从本地选择一个文件夹作为“打开仓库”的目标。
- **FR-003**: 系统 MUST 在添加到仓库列表前校验所选文件夹是否包含可识别且有效的仓库元信息。
- **FR-004**: 当校验通过时，系统 MUST 将该仓库加入仓库列表，并使用户可从列表打开该仓库。
- **FR-005**: 当校验不通过时，系统 MUST 不将其加入仓库列表，并向用户展示可理解、可执行下一步的失败原因提示。
- **FR-006**: 系统 MUST 防止同一仓库被重复添加到仓库列表；若用户选择了已存在的仓库，系统 MUST 以“打开已有条目/定位已有条目”的方式处理。
- **FR-007**: 系统 MUST 记住仓库列表中每个仓库对应的本地位置（或等价的可重新定位信息），以便后续打开。
- **FR-008**: 当仓库列表中的仓库位置不可用时，系统 MUST 在用户尝试打开时给出明确提示，并提供至少一种恢复路径（例如移除条目、重新选择位置）。

### Key Entities *(include if feature involves data)*

- **仓库（Repository）**: 用户希望在 App 中管理的工作目录集合；具有名称/标识、在本机的存放位置、以及可验证的仓库元信息。
- **仓库元信息（Repository Metadata）**: 用于识别“该文件夹是某个仓库”以及读取必要信息的最小数据集合（例如仓库标识、版本等）。
- **仓库列表项（Repository List Item）**: App 仓库列表中的一条记录；关联到一个仓库及其本地位置，支持打开与状态展示（可用/不可用）。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 95% 的用户在首次尝试中可在 30 秒内完成“打开仓库并出现在仓库列表”的任务（从点击“+”开始计时，到列表可见为止）。
- **SC-002**: 对于“非仓库文件夹/元信息损坏/不可访问位置”三类失败场景，用户能在不查看帮助文档的情况下理解失败原因并完成下一步操作（重新选择或取消），可用性测试中任务继续率 ≥ 90%。
- **SC-003**: 重复添加同一仓库时，不产生重复列表项；用户能够在 10 秒内定位到已有仓库并打开（可用性测试）。
- **SC-004**: 功能上线后，与“无法打开/重复仓库/误添加文件夹”相关的用户反馈（或支持工单）在 4 周内不高于“新建仓库功能”相关反馈量的 10%。

## Assumptions

- 用户的“已有仓库”指本机磁盘上的一个文件夹，且其中存在可用于识别的仓库元信息。
- “打开仓库（添加已有仓库）”的目标是把仓库加入 App 仓库列表并可进入；不要求自动导入/迁移额外数据。

## Out of Scope

- 从远端下载/克隆仓库。
- 在打开已有仓库过程中对仓库内容做批量重写或结构升级（如确有升级需求，应另立功能并明确迁移策略）。 

## Clarifications

### Session 2025-12-25

- Q: 是否需要保留原有“新建仓库”入口与能力，不被本次改动替换或移除？ → A: 需要。新增“打开仓库”作为并列入口，且“新建仓库”的入口与行为保持可用与不回归。
